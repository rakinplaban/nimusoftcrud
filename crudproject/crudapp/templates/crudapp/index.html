{% extends 'crudapp/layout.html' %}

{% block title %}Book CRUD{% endblock %}

{% block body %}
    <div class="container mt-5">
        <h1 class="mb-4 text-center">Book List</h1>

        <form id="bookForm" class="row g-3">
            {% csrf_token %}
            <div class="col-md-4">
                <label for="title" class="form-label">Title</label>
                <input type="text" class="form-control" id="title" placeholder="Enter title" required>
            </div>
            <div class="col-md-4">
                <label for="author" class="form-label">Author</label>
                <input type="text" class="form-control" id="author" placeholder="Enter author" required>
            </div>
            <div class="col-md-4">
                <label for="published_date" class="form-label">Published Date</label>
                <input type="date" class="form-control" id="published_date" required>
            </div>
            <div class="col-12 text-center">
                <button type="submit" class="btn btn-primary mt-3">Add Book</button>
            </div>
        </form>

        <hr class="my-4">

        <h2 class="text-center">All Books</h2>
        <ul id="bookList" class="list-group mt-4">
            {% for book in books %}
                <li class="list-group-item" id="book-{{ book.id }}">
                {{ book.title }} by {{ book.author }}, Published on {{ book.published_date }}
                <button class="btn btn-danger btn-sm float-end delete-btn" data-id="{{ book.id }}">Delete</button>
                </li>
            {% empty %}
                <li class="list-group-item">No books available</li>
            {% endfor %}
        </ul>
    </div>

    <script>
        $(document).ready(function() {
            fetchBooks();

            $('#bookForm').submit(function(e) {
                e.preventDefault();
                $.ajax({
                    url: '/create/',
                    method: 'POST',
                    data: JSON.stringify({
                        title: $('#title').val(),
                        author: $('#author').val(),
                        published_date: $('#published_date').val()
                    }),
                    contentType: 'application/json',
                    success: function(data) {
                        $('#bookList').append(`
                            <li class="list-group-item" id="book-${data.id}">
                                ${data.title} by ${data.author} 
                                <button class="btn btn-warning btn-sm float-end mx-2" onclick="editBook(${data.id})">Edit</button>
                                <button class="btn btn-danger btn-sm float-end" onclick="deleteBook(${data.id})">Delete</button>
                            </li>
                        `);
                    }
                });
            });

            window.editBook = function(id) {
                $.get(`/books/${id}/`, function(data) {
                    $('#title').val(data.title);
                    $('#author').val(data.author);
                    $('#published_date').val(data.published_date);
                    $('#bookForm').off('submit').submit(function(e) {
                        e.preventDefault();
                        $.ajax({
                            url: `/update/${id}/`,
                            method: 'POST',
                            data: JSON.stringify({
                                title: $('#title').val(),
                                author: $('#author').val(),
                                published_date: $('#published_date').val()
                            }),
                            contentType: 'application/json',
                            success: function(data) {
                                $(`#book-${data.id}`).html(`
                                    ${data.title} by ${data.author} 
                                    <button class="btn btn-warning btn-sm float-end mx-2" onclick="editBook(${data.id})">Edit</button>
                                    <button class="btn btn-danger btn-sm float-end" onclick="deleteBook(${data.id})">Delete</button>
                                `);
                            }
                        });
                    });
                });
            };

            window.deleteBook = function(id) {
                $.ajax({
                    url: `/delete/${id}/`,
                    method: 'POST',
                    success: function() {
                        $(`#book-${id}`).remove();
                    }
                });
            };
        });

        function fetchBooks() {
            $.get('/books/', function(data) {
                $('#bookList').html('');
                data.forEach(function(book) {
                    $('#bookList').append(`
                        <li class="list-group-item" id="book-${book.id}">
                            ${book.title} by ${book.author} 
                            <button class="btn btn-warning btn-sm float-end mx-2" onclick="editBook(${book.id})">Edit</button>
                            <button class="btn btn-danger btn-sm float-end" onclick="deleteBook(${book.id})">Delete</button>
                        </li>
                    `);
                });
            });
        }



    </script>
{% endblock %}
